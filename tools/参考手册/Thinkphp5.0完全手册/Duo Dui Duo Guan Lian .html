<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-CN" xml:lang="zh-CN">
  <head>
    <title>多对多关联</title>
    <meta content="IE=edge" http-equiv="X-UA-Compatible"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link href="stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="page_styles.css" rel="stylesheet" type="text/css"/>
</head>
  <body class="calibre">
        <h1 class="book-title" id="calibre_toc_115">多对多关联</h1>
<div class="book-content">
    <h2 id="%E5%A4%9A%E5%AF%B9%E5%A4%9A%E5%85%B3%E8%81%94" class="calibre15">多对多关联</h2>
<table class="calibre25"><thead class="calibre26"><tr class="calibre27"><th class="calibre28">版本</th>
<th class="calibre28">功能调整</th>
</tr></thead><tbody class="calibre29"><tr class="calibre27"><td class="pcalibre1 calibre30">5.0.6</td>
<td class="calibre34 pcalibre1"><code class="calibre7">attach</code>方法返回值改为<code class="calibre7">Pivot</code>对象</td>
</tr></tbody></table><h2 id="%E5%85%B3%E8%81%94%E5%AE%9A%E4%B9%89-2" class="calibre15">关联定义</h2>
<p class="calibre10">例如，我们的用户和角色就是一种多对多的关系，我们在User模型定义如下：</p>
<pre class="calibre21"><code class="calibre22">namespace app\index\model;

use think\Model;

class User extends Model 
{
    public function roles()
    {
        return $this-&gt;belongsToMany('Role');
    }
}</code></pre>
<p class="calibre10">belongsToMany方法的参数如下：</p>
<blockquote class="info">
<h3 id="belongstomany%28%27%E5%85%B3%E8%81%94%E6%A8%A1%E5%9E%8B%E5%90%8D%27%2C%27%E4%B8%AD%E9%97%B4%E8%A1%A8%E5%90%8D%27%2C%27%E5%A4%96%E9%94%AE%E5%90%8D%27%2C%27%E5%BD%93%E5%89%8D%E6%A8%A1%E5%9E%8B%E5%85%B3%E8%81%94%E9%94%AE%E5%90%8D%27%2C%5B%27%E6%A8%A1%E5%9E%8B%E5%88%AB%E5%90%8D%E5%AE%9A%E4%B9%89%27%5D%29%3B" class="calibre17">belongsToMany('关联模型名','中间表名','外键名','当前模型关联键名',['模型别名定义']);</h3>
</blockquote>
<h3 id="%E5%85%B3%E8%81%94%E6%9F%A5%E8%AF%A2-2" class="calibre17">关联查询</h3>
<p class="calibre10">我们可以通过下面的方式获取关联数据</p>
<pre class="calibre21"><code class="calibre22">$user = User::get(1);
// 获取用户的所有角色
dump($user-&gt;roles);</code></pre>
<h3 id="%E5%85%B3%E8%81%94%E6%96%B0%E5%A2%9E-2" class="calibre17">关联新增</h3>
<pre class="calibre21"><code class="calibre22">$user = User::get(1);
// 增加关联数据 会自动写入中间表数据
$user-&gt;roles()-&gt;save(['name'=&gt;'管理员']);
// 批量增加关联数据
$user-&gt;roles()-&gt;saveAll([
    ['name'=&gt;'管理员'],
    ['name'=&gt;'操作员'],
]);</code></pre>
<p class="calibre10">只新增中间表数据，可以使用</p>
<pre class="calibre21"><code class="calibre22">$user = User::get(1);
// 仅增加关联的中间表数据
$user-&gt;roles()-&gt;save(1);
// 或者
$role = Role::get(1);
$user-&gt;roles()-&gt;save($role);
// 批量增加关联数据
$user-&gt;roles()-&gt;saveAll([1,2,3]);</code></pre>
<p class="calibre10">单独更新中间表数据，可以使用：</p>
<pre class="calibre21"><code class="calibre22">$user = User::get(1);
// 增加关联的中间表数据
$user-&gt;roles()-&gt;attach(1);
// 传入中间表的额外属性
$user-&gt;roles()-&gt;attach(1,['remark'=&gt;'test']);
// 删除中间表数据
$user-&gt;roles()-&gt;detach([1,2,3]);</code></pre>
<blockquote class="danger">
<p class="calibre14"><code class="calibre7">V5.0.6+</code>版本开始，<code class="calibre7">attach</code>方法的返回值是一个<code class="calibre7">Pivot</code>对象实例，如果是附加多个关联数据，则返回<code class="calibre7">Pivot</code>对象实例的数组。</p>
</blockquote>
<h3 id="%E5%AE%9A%E4%B9%89%E7%9B%B8%E5%AF%B9%E7%9A%84%E5%85%B3%E8%81%94-2" class="calibre17">定义相对的关联</h3>
<p class="calibre10">我们可以在<code class="calibre7">Role</code>模型中定义一个相对的关联关系，例如：</p>
<pre class="calibre21"><code class="calibre22">namespace app\index\model;

use think\Model;

class Role extends Model 
{
    public function users()
    {
        return $this-&gt;belongsToMany('User');
    }
}</code></pre>
</div>
	
</body></html>
