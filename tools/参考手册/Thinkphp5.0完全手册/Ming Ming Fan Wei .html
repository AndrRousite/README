<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-CN" xml:lang="zh-CN">
  <head>
    <title>查询范围</title>
    <meta content="IE=edge" http-equiv="X-UA-Compatible"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link href="stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="page_styles.css" rel="stylesheet" type="text/css"/>
</head>
  <body class="calibre">
        <h1 class="book-title" id="calibre_toc_106">查询范围</h1>
<div class="book-content">
    <p class="calibre10">可以对模型的查询和写入操作进行封装，例如：</p>
<pre class="calibre21"><code class="calibre22">namespace app\index\model;

use think\Model;

class User extends Model
{

    protected function scopeThinkphp($query)
    {
        $query-&gt;where('name','thinkphp')-&gt;field('id,name');
    }

    protected function scopeAge($query)
    {
        $query-&gt;where('age','&gt;',20)-&gt;limit(10);
    }    

}</code></pre>
<p class="calibre10">就可以进行下面的条件查询：</p>
<pre class="calibre21"><code class="calibre22">// 查找name为thinkphp的用户
User::scope('thinkphp')-&gt;get();
// 查找年龄大于20的10个用户
User::scope('age')-&gt;all();
// 查找name为thinkphp的用户并且年龄大于20的10个用户
User::scope('thinkphp,age')-&gt;all();</code></pre>
<p class="calibre10">可以直接使用闭包函数进行查询，例如：</p>
<pre class="calibre21"><code class="calibre22">User::scope(function($query){
    $query-&gt;where('age','&gt;',20)-&gt;limit(10);
})-&gt;all();</code></pre>
<p class="calibre10">支持动态调用的方式，例如：</p>
<pre class="calibre21"><code class="calibre22">$user = new User;
// 查找name为thinkphp的用户
$user-&gt;thinkphp()-&gt;get();
// 查找年龄大于20的10个用户
$user-&gt;age()-&gt;all();
// 查找name为thinkphp的用户并且年龄大于20的10个用户
$user-&gt;thinkphp()-&gt;age()-&gt;all();</code></pre>
<blockquote class="danger">
<p class="calibre14">命名范围方法之前不能调用查询的连贯操作方法，必须首先被调用。</p>
</blockquote>
<h2 id="%E5%85%A8%E5%B1%80%E6%9F%A5%E8%AF%A2%E8%8C%83%E5%9B%B4" class="calibre15">全局查询范围</h2>
<p class="calibre10">如果你的所有查询都需要一个基础的查询范围，那么可以在模型类里面定义一个静态的<code class="calibre7">base</code>方法，例如：</p>
<pre class="calibre21"><code class="calibre22">namespace app\index\model;

use think\Model;

class User extends Model
{
    // 定义全局的查询范围
    protected function base($query)
    {
        $query-&gt;where('status',1);
    }
}</code></pre>
<blockquote class="danger">
<p class="calibre14">全局查询范围方法在5.0.2版本之前必须定义为<code class="calibre7">static</code>静态方法。</p>
</blockquote>
<p class="calibre10">然后，执行下面的代码：</p>
<pre class="calibre21"><code class="calibre22">$user = User::get(1);</code></pre>
<p class="calibre10">最终的查询条件会是</p>
<pre class="calibre21"><code class="calibre22">status = 1 AND id = 1</code></pre>
<p class="calibre10">如果需要动态关闭/开启全局查询访问，可以使用：</p>
<pre class="calibre21"><code class="calibre22">// 关闭全局查询范围
User::useGlobalScope(false)-&gt;get(1);
// 开启全局查询范围
User::useGlobalScope(true)-&gt;get(2);</code></pre>
</div>
	
</body></html>
