<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-CN" xml:lang="zh-CN">
  <head>
    <title>更新</title>
    <meta content="IE=edge" http-equiv="X-UA-Compatible"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link href="stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="page_styles.css" rel="stylesheet" type="text/css"/>
</head>
  <body class="calibre">
        <h1 class="book-title" id="calibre_toc_95">更新</h1>
<div class="book-content">
    <h2 id="%E6%9F%A5%E6%89%BE%E5%B9%B6%E6%9B%B4%E6%96%B0" class="calibre15">查找并更新</h2>
<p class="calibre10">在取出数据后，更改字段内容后更新数据。</p>
<pre class="calibre21"><code class="calibre22">$user = User::get(1);
$user-&gt;name     = 'thinkphp';
$user-&gt;email    = 'thinkphp@qq.com';
$user-&gt;save();</code></pre>
<h2 id="%E7%9B%B4%E6%8E%A5%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE" class="calibre15">直接更新数据</h2>
<p class="calibre10">也可以直接带更新条件来更新数据</p>
<pre class="calibre21"><code class="calibre22">$user = new User;
// save方法第二个参数为更新条件
$user-&gt;save([
    'name'  =&gt; 'thinkphp',
    'email' =&gt; 'thinkphp@qq.com'
],['id' =&gt; 1]);</code></pre>
<p class="calibre10">上面两种方式更新数据，如果需要过滤非数据表字段的数据，可以使用：</p>
<pre class="calibre21"><code class="calibre22">$user = new User();
// 过滤post数组中的非数据表字段数据
$user-&gt;allowField(true)-&gt;save($_POST,['id' =&gt; 1]);</code></pre>
<p class="calibre10">如果你通过外部提交赋值给模型，并且希望指定某些字段写入，可以使用：</p>
<pre class="calibre21"><code class="calibre22">$user = new User();
// post数组中只有name和email字段会写入
$user-&gt;allowField(['name','email'])-&gt;save($_POST, ['id' =&gt; 1]);</code></pre>
<h2 id="%E6%89%B9%E9%87%8F%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE" class="calibre15">批量更新数据</h2>
<p class="calibre10">可以使用saveAll方法批量更新数据，例如：</p>
<pre class="calibre21"><code class="calibre22">$user = new User;
$list = [
    ['id'=&gt;1, 'name'=&gt;'thinkphp', 'email'=&gt;'thinkphp@qq.com'],
    ['id'=&gt;2, 'name'=&gt;'onethink', 'email'=&gt;'onethink@qq.com']
];
$user-&gt;saveAll($list);</code></pre>
<blockquote class="calibre5">
<p class="calibre14">批量更新仅能根据主键值进行更新，其它情况请使用<code class="calibre7">foreach</code>遍历更新。</p>
</blockquote>
<p class="calibre10">如果你自己通过遍历批量更新数据，可以参考下面的方法：</p>
<pre class="calibre21"><code class="calibre22">$user = new User;
$list = [
    ['id'=&gt;1, 'name'=&gt;'thinkphp', 'email'=&gt;'thinkphp@qq.com'],
    ['id'=&gt;2, 'name'=&gt;'onethink', 'email'=&gt;'onethink@qq.com']
];
foreach($list as $data){
    $user-&gt;data($data,true)-&gt;isUpdate(true)-&gt;save();
}</code></pre>
<h2 id="%E9%80%9A%E8%BF%87%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B1%BB%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE" class="calibre15">通过数据库类更新数据</h2>
<p class="calibre10">必要的时候，你也可以使用数据库对象来直接更新数据，但这样就无法使用模型的事件功能。</p>
<pre class="calibre21"><code class="calibre22">$user = new User;
$user-&gt;where('id', 1)
    -&gt;update(['name' =&gt; 'thinkphp']);</code></pre>
<p class="calibre10">或者使用：</p>
<pre class="calibre21"><code class="calibre22">$user = new User;
$user-&gt;update(['id' =&gt; 1, 'name' =&gt; 'thinkphp']);</code></pre>
<blockquote class="calibre5">
<p class="calibre14">如果传入<code class="calibre7">update</code>的数据包含主键的话，可以无需使用<code class="calibre7">where</code>方法。</p>
</blockquote>
<h2 id="%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95-1" class="calibre15">静态方法</h2>
<p class="calibre10">模型支持静态方法直接更新数据，例如：</p>
<pre class="calibre21"><code class="calibre22">User::where('id', 1)
    -&gt;update(['name' =&gt; 'thinkphp']);</code></pre>
<p class="calibre10">或者使用：</p>
<pre class="calibre21"><code class="calibre22">User::update(['id' =&gt; 1, 'name' =&gt; 'thinkphp']);</code></pre>
<h2 id="%E9%97%AD%E5%8C%85%E6%9B%B4%E6%96%B0" class="calibre15">闭包更新</h2>
<p class="calibre10">可以通过闭包函数使用更复杂的更新条件，例如：</p>
<pre class="calibre21"><code class="calibre22">$user = new User;
$user-&gt;save(['name' =&gt; 'thinkphp'],function($query){
    // 更新status值为1 并且id大于10的数据
    $query-&gt;where('status', 1)-&gt;where('id', '&gt;', 10);
});</code></pre>
<h2 id="%E8%87%AA%E5%8A%A8%E8%AF%86%E5%88%AB" class="calibre15">自动识别</h2>
<p class="calibre10">我们已经看到，模型的新增和更新方法都是<code class="calibre7">save</code>方法，系统有一套默认的规则来识别当前的数据需要更新还是新增。</p>
<ul class="calibre23"><li class="calibre20">实例化模型后调用save方法表示新增；</li>
<li class="calibre20">查询数据后调用save方法表示更新；</li>
<li class="calibre20">调用模型的save方法后表示更新；</li>
</ul><p class="calibre10">如果你的数据操作比较复杂，可以显式的指定当前调用<code class="calibre7">save</code>方法是新增操作还是更新操作。</p>
<p class="calibre10">显式更新数据：</p>
<pre class="calibre21"><code class="calibre22">// 实例化模型
$user = new User;
// 显式指定更新数据操作
$user-&gt;isUpdate(true)
    -&gt;save(['id' =&gt; 1, 'name' =&gt; 'thinkphp']);</code></pre>
<p class="calibre10">显示新增数据：</p>
<pre class="calibre21"><code class="calibre22">$user = User::get(1);
$user-&gt;name = 'thinkphp';
// 显式指定当前操作为新增操作
$user-&gt;isUpdate(false)-&gt;save();</code></pre>
<p class="calibre10">注意不要在一个模型实例里面做多次更新，会导致部分重复数据不再更新，正确的方式应该是先查询后更新或者使用模型类的<code class="calibre7">update</code>方法更新。</p>
<blockquote class="calibre5">
<p class="calibre14">如果你调用save方法进行多次数据写入的时候，需要注意，第二次save方法的时候必须使用isUpdate(false)，否则会视为更新数据。</p>
</blockquote>
</div>
	
</body></html>
