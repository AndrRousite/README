<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-CN" xml:lang="zh-CN">
  <head>
    <title>分布式数据库</title>
    <meta content="IE=edge" http-equiv="X-UA-Compatible"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link href="stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="page_styles.css" rel="stylesheet" type="text/css"/>
</head>
  <body class="calibre">
        <h1 class="book-title" id="calibre_toc_90">分布式数据库</h1>
<div class="book-content">
    <p class="calibre10">ThinkPHP内置了分布式数据库的支持，包括主从式数据库的读写分离，但是分布式数据库必须是相同的数据库类型。</p>
<p class="calibre10">配置<code class="calibre7">database.deploy</code> 为1 可以采用分布式数据库支持。如果采用分布式数据库，定义数据库配置信息的方式如下：</p>
<pre class="calibre21"><code class="calibre22">//分布式数据库配置定义
return [
    // 启用分布式数据库
    'deploy'    =&gt;  1,
    // 数据库类型
    'type'        =&gt; 'mysql',
    // 服务器地址
    'hostname'    =&gt; '192.168.1.1,192.168.1.2',
    // 数据库名
    'database'    =&gt; 'demo',
    // 数据库用户名
    'username'    =&gt; 'root',
    // 数据库密码
    'password'    =&gt; '',
    // 数据库连接端口
    'hostport'    =&gt; '',
]</code></pre>
<p class="calibre10">连接的数据库个数取决于<code class="calibre7">hostname</code>定义的数量，所以即使是两个相同的IP也需要重复定义，但是其他的参数如果存在相同的可以不用重复定义，例如：</p>
<pre class="calibre21"><code class="calibre22">'hostport'=&gt;'3306,3306'</code></pre>
<p class="calibre10">和</p>
<pre class="calibre21"><code class="calibre22">'hostport'=&gt;'3306'</code></pre>
<p class="calibre10">等效。</p>
<pre class="calibre21"><code class="calibre22">'username'=&gt;'user1', 
'password'=&gt;'pwd1', </code></pre>
<p class="calibre10">和</p>
<pre class="calibre21"><code class="calibre22">'username'=&gt;'user1,user1', 
'password'=&gt;'pwd1,pwd1',</code></pre>
<p class="calibre10">等效。</p>
<p class="calibre10">还可以设置分布式数据库的读写是否分离，默认的情况下读写不分离，也就是每台服务器都可以进行读写操作，对于主从式数据库而言，需要设置读写分离，通过下面的设置就可以：</p>
<pre class="calibre21"><code class="calibre22">    'rw_separate' =&gt; true,</code></pre>
<p class="calibre10">在读写分离的情况下，默认第一个数据库配置是主服务器的配置信息，负责写入数据，如果设置了<code class="calibre7">master_num</code>参数，则可以支持多个主服务器写入。其它的都是从数据库的配置信息，负责读取数据，数量不限制。每次连接从服务器并且进行读取操作的时候，系统会随机进行在从服务器中选择。</p>
<p class="calibre10">还可以设置<code class="calibre7">slave_no</code> 指定某个服务器进行读操作。</p>
<blockquote class="calibre5">
<p class="calibre14">如果从数据库连接错误，会自动切换到主数据库连接。</p>
</blockquote>
<p class="calibre10">调用模型的CURD操作的话，系统会自动判断当前执行的方法的读操作还是写操作，如果你用的是原生SQL，那么需要注意系统的默认规则： <strong class="calibre12">写操作必须用模型的execute方法，读操作必须用模型的query方法</strong>，否则会发生主从读写错乱的情况。</p>
<blockquote class="calibre5">
<p class="calibre14">注意：主从数据库的数据同步工作不在框架实现，需要数据库考虑自身的同步或者复制机制。</p>
</blockquote>
</div>
	
</body></html>
