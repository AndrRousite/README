<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-CN" xml:lang="zh-CN">
  <head>
    <title>软删除</title>
    <meta content="IE=edge" http-equiv="X-UA-Compatible"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link href="stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="page_styles.css" rel="stylesheet" type="text/css"/>
</head>
  <body class="calibre">
        <h1 class="book-title" id="calibre_toc_103">软删除</h1>
<div class="book-content">
    <h2 id="%E8%BD%AF%E5%88%A0%E9%99%A4" class="calibre15">软删除</h2>
<table class="calibre25"><thead class="calibre26"><tr class="calibre27"><th class="calibre28">版本</th>
<th class="calibre28">调整功能</th>
</tr></thead><tbody class="calibre29"><tr class="calibre27"><td class="pcalibre1 calibre30">5.0.2</td>
<td class="calibre34 pcalibre1"><code class="calibre7">deleteTime</code> 属性改为非静态定义</td>
</tr></tbody></table><p class="calibre10">在实际项目中，对数据频繁使用删除操作会导致性能问题，软删除的作用就是把数据加上删除标记，而不是真正的删除，同时也便于需要的时候进行数据的恢复。</p>
<p class="calibre10">要使用软删除功能，需要引入<code class="calibre7">SoftDelete</code> trait，例如<code class="calibre7">User</code>模型按照下面的定义就可以使用软删除功能：</p>
<pre class="calibre21"><code class="calibre22">namespace app\index\model;

use think\Model;
use traits\model\SoftDelete;

class User extends Model
{
    use SoftDelete;
    protected $deleteTime = 'delete_time';
}</code></pre>
<blockquote class="danger">
<p class="calibre14"><code class="calibre7">5.0.2</code>版本之前<code class="calibre7">deleteTime</code>属性必须使用<code class="calibre7">static</code>定义。</p>
</blockquote>
<p class="calibre10"><code class="calibre7">deleteTime</code>属性用于定义你的软删除标记字段，<code class="calibre7">ThinkPHP5</code>的软删除功能使用时间戳类型（数据表默认值为<code class="calibre7">Null</code>），用于记录数据的删除时间。</p>
<blockquote class="calibre5">
<p class="calibre14">可以用类型转换指定软删除字段的类型，建议数据表的所有时间字段统一一种类型。</p>
</blockquote>
<p class="calibre10">定义好模型后，我们就可以使用：</p>
<pre class="calibre21"><code class="calibre22">// 软删除
User::destroy(1);
// 真实删除
User::destroy(1,true);
$user = User::get(1);
// 软删除
$user-&gt;delete();
// 真实删除
$user-&gt;delete(true);</code></pre>
<p class="calibre10">默认情况下查询的数据不包含软删除数据，如果需要包含软删除的数据，可以使用下面的方式查询：</p>
<pre class="calibre21"><code class="calibre22">User::withTrashed()-&gt;find();
User::withTrashed()-&gt;select();</code></pre>
<p class="calibre10">如果仅仅需要查询软删除的数据，可以使用：</p>
<pre class="calibre21"><code class="calibre22">User::onlyTrashed()-&gt;find();
User::onlyTrashed()-&gt;select();</code></pre>
<blockquote class="danger">
<p class="calibre14">如果你的模型定义了<code class="calibre7">base</code>基础查询，请确保添加软删除的基础查询条件。</p>
</blockquote>
</div>
	
</body></html>
