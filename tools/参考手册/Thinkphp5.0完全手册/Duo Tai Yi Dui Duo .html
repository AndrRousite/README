<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-CN" xml:lang="zh-CN">
  <head>
    <title>多态一对多</title>
    <meta content="IE=edge" http-equiv="X-UA-Compatible"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link href="stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="page_styles.css" rel="stylesheet" type="text/css"/>
</head>
  <body class="calibre">
        <h1 class="book-title" id="calibre_toc_116">多态一对多</h1>
<div class="book-content">
    <h2 id="%E5%A4%9A%E6%80%81%E4%B8%80%E5%AF%B9%E5%A4%9A%E5%85%B3%E8%81%94%EF%BC%88%60v5.0.4%2B%60%EF%BC%89" class="calibre15">多态一对多关联（<code class="calibre7">V5.0.4+</code>）</h2>
<p class="calibre10">多态关联允许一个模型在单个关联定义方法中从属一个以上其它模型，例如用户可以评论书和文章，但评论表通常都是同一个数据表的设计。多态一对多关联关系，就是为了满足类似的使用场景而设计。</p>
<p class="calibre10">下面是关联表的数据表结构：</p>
<pre class="calibre21"><code class="calibre22">article
    id - integer
    title - string
    content - text

book
    id - integer
    title - string

comment
    id - integer
    content - text
    commentable_id - integer
    commentable_type - string</code></pre>
<p class="calibre10">有两个需要注意的字段是 <code class="calibre7">comment</code> 表中的 <code class="calibre7">commentable_id</code> 和 <code class="calibre7">commentable_type</code>我们称之为多态字段。其中， <code class="calibre7">commentable_id</code> 用于存放书或者文章的 id（主键） ，而 <code class="calibre7">commentable_type</code> 用于存放所属模型的类型。通常的设计是多态字段有一个公共的前缀（例如这里用的<code class="calibre7">commentable</code>），当然，也支持设置完全不同的字段名（例如使用<code class="calibre7">data_id</code>和<code class="calibre7">type</code>）。</p>
<h3 id="%E5%A4%9A%E6%80%81%E5%85%B3%E8%81%94%E5%AE%9A%E4%B9%89" class="calibre17">多态关联定义</h3>
<p class="calibre10">接着，让我们来查看创建这种关联所需的模型定义：</p>
<p class="calibre10">文章模型：</p>
<pre class="calibre21"><code class="calibre22">&lt;?php
namespace app\index\model;

use think\Model;

class Article extends Model
{
    /**
     * 获取所有针对文章的评论。
     */
    public function comments()
    {
        return $this-&gt;morphMany('Comment', 'commentable');
    }
}</code></pre>
<p class="calibre10"><code class="calibre7">morphMany</code>方法的参数如下：</p>
<blockquote class="info">
<h3 id="morphmany%28%27%E5%85%B3%E8%81%94%E6%A8%A1%E5%9E%8B%E5%90%8D%27%2C%27%E5%A4%9A%E6%80%81%E5%AD%97%E6%AE%B5%E4%BF%A1%E6%81%AF%27%2C%27%E5%A4%9A%E6%80%81%E7%B1%BB%E5%9E%8B%27%29%3B" class="calibre17">morphMany('关联模型名','多态字段信息','多态类型');</h3>
</blockquote>
<p class="calibre10"><strong class="calibre12">关联模型名</strong>（必须）：关联的模型名称，可以使用模型名（如<code class="calibre7">Comment</code>）或者完整的命名空间模型名（如<code class="calibre7">app\index\model\Comment</code>）。</p>
<p class="calibre10"><strong class="calibre12">多态字段信息</strong>（可选）：支持两种方式定义 如果是字符串表示多态字段的前缀，多态字段使用 <code class="calibre7">多态前缀_type</code>和<code class="calibre7">多态前缀_id</code>，如果是数组，表示使用['多态类型字段名','多态ID字段名']，默认为当前的关联方法名作为字段前缀。</p>
<p class="calibre10"><strong class="calibre12">多态类型</strong>（可选）：当前模型对应的多态类型，默认为当前模型名，可以使用模型名（如<code class="calibre7">Article</code>）或者完整的命名空间模型名（如<code class="calibre7">app\index\model\Article</code>）。</p>
<p class="calibre10">书籍模型：</p>
<pre class="calibre21"><code class="calibre22">&lt;?php
namespace app\index\model;

use think\Model;

class Book extends Model
{
    /**
     * 获取所有针对书籍的评论。
     */
    public function comments()
    {
        return $this-&gt;morphMany('Comment', 'commentable');
    }
}</code></pre>
<p class="calibre10">书籍模型的设置方法同文章模型一致，区别在于多态类型不同，但由于多态类型默认会取当前模型名，因此不需要单独设置。</p>
<p class="calibre10">下面是评论模型的关联定义：</p>
<pre class="calibre21"><code class="calibre22">&lt;?php
namespace app\index\model;

use think\Model;

class Comment extends Model
{
    /**
     * 获取评论对应的多态模型。
     */
    public function commentable()
    {
        return $this-&gt;morphTo();
    }
}</code></pre>
<p class="calibre10"><code class="calibre7">morphTo</code>方法的参数如下：</p>
<blockquote class="info">
<h3 id="morphto%28%27%E5%A4%9A%E6%80%81%E5%AD%97%E6%AE%B5%E4%BF%A1%E6%81%AF%27%2C%5B%27%E5%A4%9A%E6%80%81%E7%B1%BB%E5%9E%8B%E5%88%AB%E5%90%8D%27%5D%29%3B" class="calibre17">morphTo('多态字段信息',['多态类型别名']);</h3>
</blockquote>
<p class="calibre10"><strong class="calibre12">多态字段信息</strong>（可选）：支持两种方式定义 如果是字符串表示多态字段的前缀，多态字段使用 <code class="calibre7">多态前缀_type</code>和<code class="calibre7">多态前缀_id</code>，如果是数组，表示使用['多态类型字段名','多态ID字段名']，默认为当前的关联方法名作为字段前缀<br class="calibre16"/><strong class="calibre12">多态类型别名</strong>（可选）：数组方式定义</p>
<h3 id="%E8%8E%B7%E5%8F%96%E5%A4%9A%E6%80%81%E5%85%B3%E8%81%94" class="calibre17">获取多态关联</h3>
<p class="calibre10">一旦你的数据表及模型被定义，则可以通过模型来访问关联。例如，若要访问某篇文章的所有评论，则可以简单的使用 <code class="calibre7">comments</code> 动态属性：</p>
<pre class="calibre21"><code class="calibre22">$article = Article::get(1);

foreach ($article-&gt;comments as $comment) {
    dump($comment);
}</code></pre>
<p class="calibre10">你也可以从多态模型的多态关联中，通过访问调用 <code class="calibre7">morphTo</code> 的方法名称来获取拥有者，也就是此例子中 <code class="calibre7">Comment</code> 模型的 <code class="calibre7">commentable</code> 方法。所以，我们可以使用动态属性来访问这个方法：</p>
<pre class="calibre21"><code class="calibre22">$comment = Comment::get(1);
$commentable = $comment-&gt;commentable;</code></pre>
<p class="calibre10"><code class="calibre7">Comment</code> 模型的 <code class="calibre7">commentable</code> 关联会返回 <code class="calibre7">Article</code> 或 <code class="calibre7">Book</code> 模型的对象实例，这取决于评论所属模型的类型。</p>
<h3 id="%E8%87%AA%E5%AE%9A%E4%B9%89%E5%A4%9A%E6%80%81%E5%85%B3%E8%81%94%E7%9A%84%E7%B1%BB%E5%9E%8B%E5%AD%97%E6%AE%B5" class="calibre17">自定义多态关联的类型字段</h3>
<p class="calibre10">默认情况下，ThinkPHP 会使用模型名作为多态表的类型区分，例如，<code class="calibre7">Comment</code>属于 <code class="calibre7">Article</code> 或者 <code class="calibre7">Book</code> , <code class="calibre7">commentable_type</code> 的默认值可以分别是 <code class="calibre7">Article</code> 或者 <code class="calibre7">Book</code> 。我们可以通过定义多态的时候传入参数来对数据库进行解耦。</p>
<pre class="calibre21"><code class="calibre22">    public function commentable()
    {
        return $this-&gt;morphTo('commentable',[
            'book'  =&gt;  'app\index\model\Book',
            'post'  =&gt;  'app\admin\model\Article',
        ]);
    }</code></pre>
</div>
	
</body></html>
